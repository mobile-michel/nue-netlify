if(typeof global=="object")global.window=null;var w=["path_params","query","session","local","emit_only","memory"],l={},a=[],r,c={setup(e={}){let{route:t="",query:n=[],memory:o=[]}=e;if(r={...e,path_params:L(t),route:t,query:n,memory:o},window){if(r.autolink)P();addEventListener("popstate",v)}},get data(){return x(!window?l:{...p(sessionStorage),...p(localStorage),...u(location),...l})},on(e,t){let n=g(e,t);a[n>=0?n:a.length]={names:e,fn:t}},off(e,t){let n=g(e,t);if(n>=0)a.splice(n,1)},emit(e,t){if(r.emit_only?.includes(e))d({[e]:t})},set(e,t){let{changes:n,at:o}=_(this.data,e);if(o.size){if(E(n),d(n),window&&!t)q(o,{...c.data,...n})}},init(){d(u(location))},clear(){l={},a=[]}},k=new Proxy(c,{get(e,t){return e[t]||e.data[t]},set(e,t,n){if(e[t])console.error(`(fail) cannot override state.${t}`);return e.set({[t]:n}),!0}});function x(e){for(let t in e){let n=e[t];if(n==null)delete e[t];else if(n=="true")e[t]=!0;else if(n=="false")e[t]=!1;else if(typeof n=="string"&&n!=""&&!isNaN(+n))e[t]=+n}return e}function q(e,t){let n=r.query[0]?R(r.query,t):"";if(e.has("path_params"))history.pushState(!0,0,N(r.route,t)+n);else if(e.has("query"))history.replaceState(!0,0,n||"./")}function v({state:e}){e?c.set(u(location),!0):c.init()}function P(e=document){e.addEventListener("click",(t)=>{let n=t.target.closest("a[href]");if(!n||t.defaultPrevented||t.metaKey||t.ctrlKey||!h(r.route,n.pathname))return;c.set(u(n)),t.preventDefault()})}function _(e,t){let n=new Set,o={};for(let s in t)for(let i of w)if(r[i]?.includes(s)&&e[s]!==t[s])o[s]=t[s],n.add(i);return{changes:o,at:n}}function d(e){for(let t of a)if(t.names.split(" ").some((n)=>(n in e)))t.fn(e)}function E(e){for(let t in e){let n=e[t];if(r.session?.includes(t))m(sessionStorage,t,n);else if(r.local?.includes(t))m(localStorage,t,n);else if([...r.memory,...r.path_params,...r.query].includes(t))l[t]=n}}function g(e,t){return a.findIndex((n)=>n.names==e&&n.fn.toString()==t.toString())}function L(e){return e.split("/").filter((t)=>t[0]==":").map((t)=>t.slice(1))}function h(e,t){let n=e.split("/"),o=t.split("/"),s={};for(let i=1;i<n.length;i++){let f=n[i],y=o[i];if(f[0]==":")s[f.slice(1)]=y||null;else if(f!=y)return}return s}function D(e,t){let n=new URLSearchParams(t),o={};return e.forEach((s)=>{o[s]=n.get(s)||null}),o}function u({pathname:e,search:t}){return{...h(r.route,e),...D(r.query,t)}}function N(e,t={}){let n=e.split("/").map((s)=>s[0]==":"?t[s.slice(1)]:s),o=n.indexOf(void 0);return(o>0?n.slice(0,o+1):n).join("/").replace("//","/")}function R(e,t={}){let n={};e.forEach(function(s){let i=t[s];if(i)n[s]=i});let o=new URLSearchParams(n);return o.size?"?"+o:""}var S="$state";function p(e){return JSON.parse(e[S]||"{}")}function m(e,t,n){let o=p(e);if(o[t]!=n)return o[t]=n,e[S]=JSON.stringify(o),!0}export{k as state,R as renderQuery,N as renderPath,D as getQueryData,h as getPathData,c as api};
